var public_id=null,create_playlist=function(e){if(vk.check()){var i=$("input#nick").val();vk.type=e,$('input[type="button"]').hide(),VK.Api.call("users.get",{user_ids:i,fields:"id"},function(e){if(e.response)switch(public_id=e.response[0].uid,$.notify({message:"Waiting"},{allow_dismiss:!1,delay:5e3,type:"success"}),$('input[name="method"]:checked').val()){case"audio":vk.vk_get("audio.get",{owner_id:public_id},vk.audioHandler);break;case"wall":vk.wallHandler()}else e.error&&(vk.errorHandler(e.error.error_msg),$('input[type="button"]').show())})}},vk={user:null,type:"m3u",appID:"4781823",appPermissions:9,init:function(){function e(){function e(e){e.session?(vk.user=e.session.user,$("input#nick").val(""!=vk.user.domain?vk.user.domain:vk.user.id)):$.notify({message:"Auth failed!"},{allow_dismiss:!1,delay:5e3,type:"danger"})}VK.Auth.login(e,vk.appPermissions)}VK.init({apiId:vk.appID}),e()},check:function(){return null!=vk.user?!0:($.notify({message:"Need to allow access"},{allow_dismiss:!1,delay:2e3,type:"success"}),void vk.init())},errorHandler:function(e){$.notify({message:e},{allow_dismiss:!1,delay:5e3,type:"danger"})},vk_get:function(e,i,n){VK.Api.call(e,i,function(e){e.response?n(e.response):e.error&&$.notify({message:e.error.error_msg},{allow_dismiss:!1,delay:5e3,type:"danger"})})},audioHandler:function(e){e.shift(),vk.ajaxCall(JSON.stringify(e))},wallHandler:function(){function e(s){vk.vk_get("wall.get",{owner_id:public_id,count:100,offset:s},function(s){i(s),s.length>100?(t+=100,e(t)):vk.ajaxCall(JSON.stringify(n))})}function i(e){for(var i=1,t=e.length;t>i;i++){var s=e[i].attachments;if(s&&s.length>0)for(var a=1,o=s.length;o>a;a++)s[a].audio&&n.push(s[a].audio)}}var n=[],t=0;e(t)},ajaxCall:function(e){$.ajax({type:"POST",url:"/playlist",data:{nick:$("input#nick").val(),type:vk.type,method:$('input[name="method"]:checked').val(),items:e},success:function(e){if($('input[type="button"]').show(),e.ok){var i=document.getElementById(vk.type);i.href=e.path,i.click()}else $.notify({message:e.error},{allow_dismiss:!1,delay:5e3,type:"danger"})},error:function(){$('input[type="button"]').show()}})}};$(document).ready(vk.init());
